{% extends 'mainbase.html' %}

{% block head %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/menu.css' %}">
<style>
    table{
        counter-reset: Serial;
    }
    tr td:first-child:before{
        counter-increment: Serial;
        content: counter(Serial);
    }
</style>
{% endblock head %}

{% block title %}
Menu
{% endblock title %}

{% block body %}
<div class="row h-100" id="app">
    <div class="col-md-2"></div>
    <div class="col">
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">No</th>
                    <th scope="col">Item Name</th>
                    <th scope="col">Price</th>
                    <th scope="col">Quantity</th>
                    <th scope="col">Total</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(cartitem, index) in cart">
                    <td></td>
                    <td>[[cartitem.item.name]]</td>
                    <td>[[cartitem.item.price]]</td>
                    <td>
                        <inc-dec :id="cartitem.item.id" :cartitemid="cartitem.id" :quantity="cartitem.quantity"
                            :total="itemtotal[cartitem.item.id]" :key="cartitem.id">
                        </inc-dec>
                    </td>
                    <td>[[ itemtotal[cartitem.item.id] ]]</td>
                </tr>
                <tr>
                    <th></th>
                    <td></td>
                    <td></td>
                    <th>Total</th>
                    <td>[[ carttotal ]]</td>
                </tr>
            </tbody>
        </table>
        <button type="button" class="btn btn-secondary">Checkout</button>
    </div>
    <div class="col-md-2"></div>
</div>
<script>
    axios.defaults.xsrfCookieName = 'csrftoken';
    axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
    Vue.component('inc-dec', {
    props: ['cartitemid','id', 'quantity'],
    data: function(){
        return{
            count: this.quantity
        }
    },
    mounted: function(){

    },
    methods: {
        increment: function(){
            this.count++
            this.decider("i")
        },
        decrement: function(){
            this.count--
            this.decider("d")
        },
        update: function(){
            axios.put("{% url 'view_cart_item' %}" + this.cartitemid, {
                item: this.id,
                quantity: this.count
            })
            .then(response =>{
                this.$parent.getcartitems()
            })
            .catch(function(error){
                alert(error)
                this.count--
            })
        },
        delete: function(){
            axios.delete("{% url 'view_cart_item' %}" + this.cartitemid)
            .then(response =>{
                this.$parent.getcartitems()
            })
            .catch(function(error){
                console.log(error.data)
            })
        },
        decider: function(typ){
            if (this.count < 0){
                this.count = 0
            }
            else if(this.count == 0){
                this.delete()
            }
            else if (typ == "i"){
                this.update()
            }
            else if (typ == "d"){
                this.update()
            }
        }
    },
    template: `<div class="input-group quantity">
                           <div class="input-group-prepend decrement-btn" style="cursor: pointer">
                                    <span v-on:click="decrement()" class="input-group-text">-</span>
                                </div>
                                <div class="col-xs-3">
                                <input type="text" style="width:50px" class="qty-input form-control text-center" min="0" max="10"
                                        v-bind:value="quantity">
                                </div>
                                <div v-on:click="increment()" class="input-group-append increment-btn" style="cursor: pointer">
                                    <span class="input-group-text">+</span>
                                </div>
                            </div>`
    });
     var app = new Vue({
        delimiters: ['[[',']]'],
        el: '#app',
        data: {
            cart: [],
            itemtotal: {},
            carttotal: 0
        },
        mounted: function() {
            this.getcartitems()
        },
        methods: {
            computeTotal: function(){
                this.carttotal = 0
                for (var cartitem of this.cart){
                    Vue.set(this.itemtotal, cartitem.item.id, cartitem.quantity*cartitem.item.price)
                    console.log(cartitem.quantity*cartitem.item.price)
                    this.carttotal += cartitem.quantity*cartitem.item.price
                }
            },
            getcartitems: function(){
                axios.get("{% url 'view_cart' %}")
                .then(response => {
                    this.cart = response.data
                    this.computeTotal()
                })
                .catch(function(error){
                    console.log(error)
                })
            }
        }
    });
</script>
{% endblock %}

