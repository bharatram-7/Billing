{% extends 'mainbase.html' %}

{% block head %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/menu.css' %}">
{% endblock head %}

{% block title %}
Menu
{% endblock title %}

{% block body %}
<div class="row h-100" id="app">
    <div class="col-md-3 menu-side">
        <div v-for="menu in menus">
            <a v-bind:href="'#'+menu.name">[[ menu.name ]]</a>
        </div>
    </div>
    <div class="col-md-6 main-content" data-spy="scroll" data-target="menu-side">
        <div v-for="menu in menus">
            <h2 :id="menu.name">[[ menu.name ]]</h2>
            <div v-for="item in menu.items">
                <div class="card mb-3" style="max-width: 740px;">
                  <div class="row no-gutters">
                    <div class="col-md-2">
                        <div v-if="item.image">
                            <img :src="item.image" style="height:128px; width:128px;"class="card-img" alt="Food">
                        </div>
                        <div v-else>
                            No image available
                        </div>
                    </div>
                    <div class="col-md-6">
                      <div class="card-body">
                        <h5 class="card-title">[[ item.name ]]</h5>
                        <p class="card-text">[[ item.description ]]</p>
                      </div>
                    </div>
                    <div class="col-md-3 align-self-center">
                        <div v-if="cartitems[item.id]">
                            <inc-dec :id="item.id" :cartitemid="cartitems[item.id]" :quantity="itemquantity[item.id]"></inc-dec>
                        </div>
                        <div v-else>
                            <inc-dec :id="item.id" :quantity="0"></inc-dec>
                        </div>
                    </div>
                  </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">Cart</div>
</div>

<script>
    axios.defaults.xsrfCookieName = 'csrftoken';
    axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
    Vue.component('inc-dec', {
    props: ['cartitemid','id', 'quantity'],
    data: function(){
        return{
            count: this.quantity
        }
    },
    mounted: function(){
        this.initCounter()
    },
    methods: {
        initCounter: function(){
            if (this.$parent.itemquantity[id]){
                this.count = this.$parent.itemquantity[id]
            }
        },
        increment: function(){
            this.count++
            this.decider("i")
        },
        decrement: function(){
            this.count--
            this.decider("d")
        },
        create: function(){
            axios.post("{% url 'view_cart_item' %}", {
                item: this.id,
                quantity: this.count
            })
            .then(response => {
                this.$parent.getcartitems()
            })
            .catch(function(error){
                alert(error.data)
                this.count--
            })
        },
        update: function(){
            axios.put("{% url 'view_cart_item' %}" + this.cartitemid, {
                item: this.id,
                quantity: this.count
            })
            .then(response =>{
                this.$parent.getcartitems()
            })
            .catch(function(error){
                alert(error)
                this.count--
            })
        },
        delete: function(){
            axios.delete("{% url 'view_cart_item' %}" + this.cartitemid)
            .then(response =>{
                this.$parent.getcartitems()
            })
            .catch(function(error){
                console.log(error.data)
            })
        },
        decider: function(typ){
            if (this.count < 0){
                this.count = 0
            }
            else if (this.count == 1 && typ == "i"){
                this.create()
            }
            else if ((this.count == 1 && typ == "d") || this.count > 1){
                this.update()
            }
            else if (this.count == 0){
                this.delete()
            }
            else{
            }
        }
    },
    template: `<div class="input-group quantity">
                           <div class="input-group-prepend decrement-btn" style="cursor: pointer">
                                    <span v-on:click="decrement()" class="input-group-text">-</span>
                                </div>
                                <div class="col-xs-8">
                                <input type="text" style="width:50px" class="qty-input form-control text-center" min="0" max="10"
                                        v-bind:value="quantity">
                                </div>
                                <div v-on:click="increment()" class="input-group-append increment-btn" style="cursor: pointer">
                                    <span class="input-group-text">+</span>
                                </div>
                            </div>`
    });

    var app = new Vue({
        delimiters: ['[[',']]'],
        el: '#app',
        data: function(){
            return{
                menus: null,
                cartitems: {},
                itemquantity: {}
            }
        },
        mounted: function() {
            axios.get("{% url 'active_menu_items' %}")
            .then(response => (this.menus = response.data))
            .catch(function(error){
                alert(error)
            })
            this.getcartitems()
        },
        methods: {
            getcartitems: function(){
            axios.get("{% url 'view_cart_item' %}")
            .then(function(response){
                for (var cartitem of response.data){
                    Vue.set(app.cartitems, cartitem.item, cartitem.id)
                    Vue.set(app.itemquantity, cartitem.item, cartitem.quantity)
                }
            })
            .catch(function(error){
                alert(error)
            })
            },
        }
    });
</script>
{% endblock body %}